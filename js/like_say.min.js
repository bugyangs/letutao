(function(a){a.guang.ilike={likeOper:function(d,e,b,g){var h="0"==b?"index.php?app=share&ac=do&le=like":"index.php?app=share&ac=do&le=identity",k="";d.data("sid")&&(k=d.data("sid"));a.ajax({url:GUANGER.path+h,type:"post",dataType:"json",data:{productId:e,commentType:"1"==b?"1":"0",sid:k},success:function(f){if(f)switch(f.code){case 100:a.guang.ilike.likeCallback(d,0,g);break;case 101:a.guang.ilike.likeCallback(d,0,g);break;case 103:a.guang.ilike.likeCallback(d,1);break;case 666:a.guang.ilike.awardClk(d)}else a.guang.tip.conf.tipClass="tipmodal tipmodal-error",
a.guang.tip.show(d,"\u8bf7\u6362\u4e00\u4e2a\u975e\u5546\u5bb6\u5e10\u53f7\u559c\u6b22\u5546\u54c1~")}})},createTopicJson:{},likeCallback:function(d,e,b){if(0==e){b&&b();var b=d.find(".ilikeCount"),g=b.data("val")+1;b.data("val",g);b.text("\u559c\u6b22("+g+")");if(""==GUANGER.userId&&(b=a.cookie("productFavor"),null!=b&&""!=b))b=b.split(",").length,a(".unlogin-like-text .count").text(b),a(".unlogin-like").show()}d.data("enable","enable");e=0==e?"\u559c\u6b22\u4e86~":"\u559c\u6b22\u8fc7\u4e86~";if(""==
GUANGER.userId)return a.guang.tip.conf.tipClass="tipmodal tipmodal-ok",a.guang.tip.show(d,e),!1;if(a("#J_LikeDialog")[0])a("#J_LikeDialog .title").html(e),a("#J_NewTopic, #J_SaySth").val(""),a("#J_LikeDialog .topic-list input:checked").each(function(){a(this)[0].checked=!1}),a("#J_LikeDialog").data("overlay").load();else{e=""+('<div id="J_LikeDialog" class="like-dialog"><div class="content"><div class="title">'+e+'</div><p>\u628a\u5b83\u52a0\u5165\u4e3b\u9898\uff0c\u65b9\u4fbf\u4e4b\u540e\u518d\u627e\u7740\u5b83~</p><div class="topic-box"><ul class="topic-list"></ul></div><div class="create-box"><a class="btn-plus" href="javascript:;"></a><input type="text" name="new-topic" id="J_NewTopic" placeholder="\u521b\u5efa\u65b0\u4e3b\u9898\uff08\u56de\u8f66\u76f4\u63a5\u521b\u5efa\uff09" /><a class="btn-enter" href="javascript:;"></a></div><div class="say-box"><input type="text" name="say-text" id="J_SaySth" placeholder="\u8bf4\u4e24\u53e5" /></div><div class="clearfix pt15" id="comment-form"><input type="button" class="bbl-btn done" value="\u5b8c\u6210" /><input type="button" class="bgr-btn cancel ml10" value="\u53d6\u6d88" /><!--<div class="share-comment"><span class="gc">\u540c\u6b65\u5206\u4eab\uff1a</span><ul id="J_UserSns"></ul><span><a href="'+
GUANGER.path+'/account/sns" target="_blank">\u8bbe\u7f6e</a></span></div>--></div><a class="close" href="javascript:;"></a></div></div>');a("body").append(e);a("#J_LikeDialog").overlay({top:"center",mask:{color:"#000",loadSpeed:200,opacity:0.3},closeOnClick:!1,load:!0});a.getJSON(GUANGER.path+"index.php?app=share&ac=do&le=getzhutiJSON&math="+Math.floor(new Date/10),function(f){if(100==f.code){var c=[];a.map(f.userTopics,function(a){c.push('<li class="ofh"><label for="'+a.themeid+'"><input type="checkbox" id="'+a.themeid+'" /> '+a.title+
"</label></li>")});a("#J_LikeDialog .topic-list").html(c.join(""))}else 110==f.code?a("#J_LikeDialog .topic-list").html('<li class="no-topic">\u4f60\u8fd8\u6ca1\u521b\u5efa\u8fc7\u4e3b\u9898</li>'):a("#J_LikeDialog .topic-list").html("<li>\u83b7\u53d6\u4e3b\u9898\u5217\u8868\u5931\u8d25</li>")});var h={sina:"ss-sina",tec_weibo:"ss-tencent",qzone:"ss-qzone"},k=a("#J_LikeDialog #J_UserSns");a.ajax({url:GUANGER.path+"/account/getUserSns.html",type:"post",dataType:"json",success:function(f){if(100==f.code){var c=
"",f=f.userSns,b;for(b in f)h[b]&&(c+='<li class="share-switch '+h[b]+"-btnclick-"+f[b]+' btnclick" data-status="'+f[b]+'" data-snsid="'+b+'" data-webname="'+h[b]+'"></li>');k.append(c);a("#J_LikeDialog .btnclick").unbind().bind("click",function(){var b=a(this),f=b.attr("data-webname")+"-btnclick-on",c=b.attr("data-webname")+"-btnclick-off";"on"==b.data("status")?b.removeClass(f).addClass(c).data("status","off"):b.removeClass(c).addClass(f).data("status","on")})}}});a("#J_LikeDialog .btn-plus").click(function(b){b.preventDefault();
a("#J_NewTopic").focus()});a("#J_NewTopic").keyup(function(b){var c=a(this);"13"==b.keyCode&&a("#J_LikeDialog .btn-enter").trigger("click");""!=a.trim(c.val())?a("#J_LikeDialog .btn-enter").show():a("#J_LikeDialog .btn-enter").hide()});a("#J_LikeDialog .btn-enter").click(function(b){b.preventDefault();var c=a("#J_NewTopic"),d=a.trim(c.val());""==d?(a.guang.tip.conf.tipClass="tipmodal tipmodal-error",a.guang.tip.show(c,"\u4e3b\u9898\u540d\u5b57\u4e0d\u80fd\u4e3a\u7a7a"),a("#J_NewTopic").focus()):(a.guang.ilike.createTopicJson.topicName=
d,a.guang.ilike.createTopicJson.gallerys="",a.ajax({url:GUANGER.path+"index.php?app=share&ac=do&le=addToTopic",type:"post",dataType:"json",data:a.guang.ilike.createTopicJson,success:function(b){100==b.code?(c.val(""),a("#J_LikeDialog .topic-list .no-topic")[0]&&a("#J_LikeDialog .topic-list .no-topic").remove(),a("#J_LikeDialog .topic-list").prepend('<li class="ofh"><label for="'+b.topicId+'"><input type="checkbox" id="'+b.topicId+'" checked /> '+d+"</label></li>")):111==b.code?a("#J_VcodeBox")[0]||(a("#J_LikeDialog .content").append('<div id="J_VcodeBox"><div class="vCode"><img src="http://www.letushuo.com/captcha" alt="\u9a8c\u8bc1\u7801" /><a class="another inlineblock" href="javascript:;">\u770b\u4e0d\u6e05\uff0c\u6362\u4e00\u4e2a</a></div><div class="captcha-row clearfix"><input type="text" name="captcha" class="base-input code-input" value="" /><a href="javascript:;" id="J_VcodeBtn" class="bbl-btn">\u63d0\u4ea4</a></div></div>'),
a("#J_VcodeBox .another").unbind("click").bind("click",function(){a("#J_VcodeBox .vCode img").attr("src","http://www.letushuo.com/captcha?"+parseInt(1E6*Math.random()))})):130==b.code?(a.guang.tip.conf.tipClass="tipmodal tipmodal-error",a.guang.tip.show(c,"\u9a8c\u8bc1\u7801\u8f93\u5165\u9519\u8bef\uff0c\u8bf7\u91cd\u8bd5~")):(a.guang.tip.conf.tipClass="tipmodal tipmodal-error",a.guang.tip.show(c,"\u521b\u5efa\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5~"));if(a.guang.ilike.createTopicJson.captcha)a.guang.ilike.createTopicJson=
{}}}))});a("#J_VcodeBtn").live("click",function(){a.guang.ilike.createTopicJson.captcha=a("#J_VcodeBox .code-input").val();a("#J_VcodeBox").empty().remove();a("#J_LikeDialog .btn-enter").trigger("click")});a("#J_LikeDialog .cancel").click(function(){a("#J_LikeDialog").data("overlay").close()})}a("#J_LikeDialog .done").unbind("click").bind("click",function(){var b=a(this),c={};if(!b.data("clicked")){var e=[];a("#J_LikeDialog .topic-list input:checked").each(function(){var b=a(this);e.push(b.attr("id"))});
c.topicIds=e.join(",");c.productId=d.data("proid");c.userComment=a.trim(a("#J_LikeDialog #J_SaySth").val());var g=a("#J_LikeDialog #J_UserSns li").length;if(0<g)for(var i=0;i<g;i++)if("on"==a("#J_LikeDialog #J_UserSns li").eq(i).data("status")){var j=a("#J_LikeDialog #J_UserSns li").eq(i).data("snsid");c.snsSiteIds=c.snsSiteIds?c.snsSiteIds+(","+j):j}var g=d.data("proname"),i=d.data("prourl"),j=c.userComment,h=135-a.guang.util.getStrLength("\u559c\u6b22\u4e86\u300a$\u300b"+g+i);c.commentContent4Sns=
a.guang.util.getStrLength(j)>h?"\u559c\u6b22\u4e86\u300a$\u300b".replace("$",g)+a.guang.util.substring4ChAndEn(j,h)+"..."+i:0==a.guang.util.getStrLength(j)?"\u559c\u6b22\u4e86\u300a$\u300b".replace("$",g)+i:"\u559c\u6b22\u4e86\u300a$\u300b".replace("$",g)+":"+j+"\u3002"+i;0==e.length&&""==j?a("#J_LikeDialog").data("overlay").close():a.ajax({url:GUANGER.path+"index.php?app=share&ac=do&le=addToTopic",type:"post",dataType:"json",data:c,beforeSend:function(){b.data("clicked",!0)},success:function(c){b.data("clicked",
!1);100==c.code?(a.guang.tip.conf.tipClass="tipmodal tipmodal-ok",a.guang.tip.show(b,"\u63d0\u4ea4\u6210\u529f~"),a("#J_LikeDialog").data("overlay").close()):(a.guang.tip.conf.tipClass="tipmodal tipmodal-error",a.guang.tip.show(b,"\u63d0\u4ea4\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5~"))}})}})}};a.guang.dialog.like_say=function(d,e){var b=a(d);if("disable"==b.data("enable"))return!1;b.data("enable","disable");var g=b.attr("data-type"),h=b.attr("data-proid");a.guang.ilike.likeOper(b,h,g,e)}})(jQuery);
